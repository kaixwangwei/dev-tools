#!/bin/sh

set -e

if [ $# -lt 1 ]; then
  echo Usage: gvimclient filename
else
  if [ "$VIMCMD" = "" ]; then
    VIMCMD=gvim
  fi
  for i in "$@"; do
    if [ ! -f "$i" ]; then
      continue
    fi

    filename="$i"
    here=`pwd`
    target=`dirname "$filename"`
    cd $target
    target_dir=`pwd`
    cd "$here"

    while [ ! -f "$target_dir/.PROJECT_NAME" -a "$target_dir" != "/" ]; do
      target_dir=`dirname "$target_dir"`
    done

    if [ -f "$target_dir/.PROJECT_NAME" ]; then
      PROJECT_NAME=`cat "$target_dir/.PROJECT_NAME"`
    else
      PROJECT_NAME="GVIM"
    fi

    if $VIMCMD --serverlist | grep -x -i -F $PROJECT_NAME -q; then
      if ! $VIMCMD --servername $PROJECT_NAME \
          --remote-expr 'GetWindowFilenames()' | \
          grep -x -F `realpath "$i"` -q; then
        sleep 1
        $VIMCMD --servername $PROJECT_NAME --remote-send '<esc>:split<cr>'
      fi
    fi

    if [ -f "$target_dir/.vimrc" ]; then
      $VIMCMD -u "$target_dir/.vimrc" \
          --servername "$PROJECT_NAME" \
          --remote-silent "$i"
    else
      $VIMCMD --servername "$PROJECT_NAME" --remote-silent "$i"
    fi
  done
fi
